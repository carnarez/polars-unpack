<!doctype html><meta charset=utf-8><meta name=viewport content="width=device-width,initial-scale=1"><title>polars-unpack</title><meta name=title content=polars-unpack><meta name=description content="Automated, schema-based JSON unpacking to Polars objects."><meta property=article:author content=carnarez><meta property=article:published_time content=2023-11-07><meta property=og:type content=article><meta property=og:url content=https://carnarez.github.io/polars-unpack><meta property=og:title content=polars-unpack><meta property=og:description content="Automated, schema-based JSON unpacking to Polars objects."><meta property=og:image content=https://source.unsplash.com/1600x900/?forest><link rel=canonical href=https://carnarez.github.io/polars-unpack><link rel=icon href=# type=image/png><link rel=stylesheet href=https://carnarez.github.io/polars-unpack/style.css><script>function setTheme(e){localStorage.setItem("theme",e),document.documentElement.className=e}function toggleTheme(){"light"===localStorage.getItem("theme")?setTheme("dark"):"dark"===localStorage.getItem("theme")?setTheme("dimmed"):setTheme("light")}"dark"===localStorage.getItem("theme")||!("theme"in localStorage)&&window.matchMedia("(prefers-color-scheme: dark)").matches?setTheme("dark"):"dimmed"===localStorage.getItem("theme")?setTheme("dimmed"):setTheme("light")</script><script>var timer;window.addEventListener("scroll",()=>{const e=document.querySelector("#scroller"),o=document.querySelector("#topbar"),r=document.querySelector("#toc"),i=document.querySelector("article");var t,l;0<e.getBoundingClientRect().top?(e.style.width="0",document.querySelectorAll("aside, article").forEach(e=>{var t=e.className.match(/visible-sidebar/)||"";0<t.length&&e.classList.remove(t)}),r.scrollTop=0):(t=window.scrollY-window.innerHeight,l=o.offsetHeight+i.offsetHeight-window.innerHeight,e.style.width=100*Math.min(t/l,1)+"%",null!==timer&&clearTimeout(timer),timer=setTimeout(()=>{var t=i.querySelectorAll("h1, h2, h3, h4, h5, h6");for(let e=0;e<t.length;e++)if(0<t[e].getBoundingClientRect().top-parseInt(getComputedStyle(document.documentElement).scrollMarginTop)-1){0===e?history.pushState({},"",window.location.pathname):history.pushState({},"","#"+t[e-1].id);break}r.querySelectorAll("a").forEach(e=>{var t=e.getAttribute("href");t.startsWith("#")&&(t===window.location.hash?(e.classList.add("active"),(e.offsetTop<r.scrollTop+o.offsetHeight||e.offsetTop>window.innerHeight-o.offsetHeight)&&(r.scrollTop=e.offsetTop-2*o.offsetHeight)):e.classList.remove("active"))})},150))}),window.onload=()=>{const r=document.querySelector("#topbar"),i=document.querySelector("#toc"),e=i.querySelectorAll("a"),l=window.location.pathname.replace(/^[/]|[/]$/g,""),t=window.location.hash,c=(e.forEach(e=>{e.setAttribute("onclick","toggleSidebar('#toc')")}),[]),o=[];e.forEach(e=>{(e.getAttribute("href").startsWith("#")?o:c).push(e)}),c.forEach((e,t)=>{var o;e.getAttribute("href").replace(/^[/]|[/]$/g,"")===l&&(e.classList.add("active"),(e.offsetTop<i.scrollTop+r.offsetHeight||e.offsetTop>window.innerHeight-r.offsetHeight)&&(i.scrollTop=e.offsetTop-2*r.offsetHeight),0<t&&(e=c[t-1],o=document.querySelector("#prev"),localStorage.setItem("prev-content",e.href),o.href=e.href,o.text=e.text),t<c.length-1)&&(o=c[t+1],e=document.querySelector("#next"),localStorage.setItem("next-content",o.href),e.href=o.href,e.text=o.text)}),o.forEach(e=>{e.getAttribute("href")===t?(e.classList.add("active"),(e.offsetTop<i.scrollTop+r.offsetHeight||e.offsetTop>window.innerHeight-r.offsetHeight)&&(i.scrollTop=e.offsetTop-2*r.offsetHeight)):e.classList.remove("active")})}</script><script>window.addEventListener("keyup",e=>{var t=document.querySelector("#scroller"),o=e.key;0===t.getBoundingClientRect().top&&"BODY"===e.srcElement.tagName&&("<"===o?window.location.href=localStorage.getItem("prev-content")||"":">"===o?window.location.href=localStorage.getItem("next-content")||"":"."===o?toggleSidebar("#toc"):"?"===o&&toggleSidebar("#search")),"INPUT"===e.srcElement.tagName&&"Escape"===o&&e.srcElement.blur()})</script><script>function toggleSidebar(e,s=void 0){var i=document.querySelector("#scroller"),o=document.querySelector("aside"+e),e=document.querySelector(`aside:not(${e})`),l=document.querySelector("article");0<i.offsetTop&&window.scroll(0,i.offsetTop),e.classList.contains("visible-sidebar")&&(e.classList.remove("visible-sidebar"),l.classList.remove("visible-sidebar")),o.classList.contains("visible-sidebar")?(o.classList.remove("visible-sidebar"),l.classList.remove("visible-sidebar"),s=void 0):(o.classList.add("visible-sidebar"),l.classList.add("visible-sidebar")),void 0!==s?document.querySelector(s).focus():document.activeElement.blur()}</script><script>function lunrSearch(){fetch("https://carnarez.github.io/polars-unpack/index.json").then(e=>e.json()).then(e=>{const t=e.documents,a=lunr.Index.load(e.indexed),o=[],r=document.querySelector("#search-input").value,c=document.querySelector("#search-output");2<r.length?(c.innerHTML=`<li>No results for "<i>${r}</i>" in current corpus.</li>`,a.search(r).forEach(r=>{const e=t[r.ref][0],c=t[r.ref][1],n=t[r.ref][2],s=parseFloat(r.score).toFixed(3);let l="";l=""===e?""!==c?"":"/":(""!==c?e+"/":e).replaceAll("/"," &gt; "),Object.keys(r.matchData.metadata).forEach(e=>{r.matchData.metadata[e].text.position.forEach(e=>{var t=document.createElement("li"),a=parseInt(e[0]),e=parseInt(e[1]);t.innerHTML=`
                      <a class="search-result" href="https://carnarez.github.io/polars-unpack/${r.ref}" onclick="toggleSidebar('#search')">
                        <div class="title">${l}${c}</div>
                        <div class="text">
                          ${n.slice(Math.max(0,a-100),a)}
                          <mark>${n.slice(a,a+e)}</mark>
                          ${n.slice(a+e,Math.min(a+e+100,n.length))}
                          <span class="score">${s}</span>
                        </div>
                      </a>
                    `,o.push(t)})})}),0<o.length&&c.replaceChildren(...o)):c.replaceChildren()})}function resetSearch(){var e=document.querySelector("#search-input"),t=document.querySelector("#search-output");e.value="",e.focus(),t.replaceChildren()}</script><script defer src=https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.9.0/highlight.min.js onload=hljs.highlightAll()></script><script defer src=https://cdnjs.cloudflare.com/ajax/libs/KaTeX/0.16.9/katex.min.js></script><script defer src=https://cdnjs.cloudflare.com/ajax/libs/KaTeX/0.16.9/contrib/auto-render.min.js onload='renderMathInElement(document.body,{delimiters:[{left:"$$",right:"$$",display:!0},{left:"$",right:"$",display:!1}]})'></script><script defer src=https://cdnjs.cloudflare.com/ajax/libs/lunr.js/2.3.9/lunr.min.js></script><nav id=topbar><div><a class=sidebar onclick='toggleSidebar("#toc")'></a> <a class=search onclick='toggleSidebar("#search","#search-input")'></a> <span class=spacer></span> <span class=spacer></span> <a class=repo href=https://github.com/carnarez/polars-unpack></a> <a class=theme onclick=toggleTheme()></a></div></nav><header id=splash><img src=splash.svg> <span class=title>polars-unpack</span> <span class=description>Automated, schema-based JSON unpacking to Polars objects.</span></header><nav id=scroller></nav><main><aside id=toc><div class=toc><ul><li><a href=/polars-unpack/ >Home</a><ul></ul><li><a href=/polars-unpack/generator>Schema generator</a><li><a href=/polars-unpack/api>API</a><li><a href=/polars-unpack/tests>Tests</a></ul></div></aside><aside id=search><header><a class=search onclick='document.querySelector("#search-input").focus()'></a> <input autocomplete=off id=search-input onkeyup=lunrSearch() placeholder="search with lunr"> <a class=reset onclick=resetSearch()></a></header><ul id=search-output></ul></aside><article><div><p>With this little experiment we tried to increase the capabilities offered by <a href=https://pola.rs><code>Polars</code></a> with the introduction of both a JSON schema parser, and an automated unpacking method available for both <code>DataFrame</code> or <code>LazyFrame</code>.<p>The initial use case can be succinctly illustrated as follows: by providing a schema written in the following <code>Polars</code>-flavoured pseudo-code...<pre class=highlight><code class=language-text>column: Utf8
nested: List(
    Struct(
        attr: UInt8
        attr2=renamed: UInt8
    )
)
missing_from_source: Float32</code></pre><p>the newline-delimited JSON file defined below...<pre class=highlight><code class=language-json>{ "column": "content", "nested": [ { "attr": 0, "attr2": 2 }, { "attr": 1, "attr2": 3 } ], "omitted_in_schema": "ignored" }</code></pre><p>gets automatically unpacked (via the <code>.json.unpack(schema)</code> method) as...<pre class=highlight><code class=language-text>┌─────────┬──────┬─────────┬─────────────────────┐
│ column  ┆ attr ┆ renamed ┆ missing_from_source │
│ ---     ┆ ---  ┆ ---     ┆ ---                 │
│ str     ┆ ui8  ┆ ui8     ┆ f32                 │
╞═════════╪══════╪═════════╪═════════════════════╡
│ content ┆ 0    ┆ 2       ┆ null                │
│ content ┆ 1    ┆ 3       ┆ null                │
└─────────┴──────┴─────────┴─────────────────────┘</code></pre><p>Note the renaming syntax as well as the missing and extra attributes, and what this all means for the final <code>Polars</code> object. More <a href=https://github.com/carnarez/polars-unpack/tree/master/tests/samples>convoluted examples</a> are provided in the repo.<p>Both the parser and the definition of the <code>.json.unpack()</code> method are contained in a single module. Make this one available on your system via a simple:<pre class=highlight><code class=language-shell>$ pip install git+https://github.com/carnarez/polars-unpack@master</code></pre><p>or:<pre class=highlight><code class=language-shell>$ wget https://raw.githubusercontent.com/carnarez/polars-unpack/master/polars_unpack/unpack.py</code></pre><p>for the module itself; whichever you find more appropriate and/or adapted to your usage. From there it is as usual:<pre class=highlight><code class=language-python>import polars as pl

from polars_unpack import (
    SchemaParser,
    UnpackFrame,  # imported to register the .json.unpack() method
)

# define the schema object
s = SchemaParser(
    "column: Utf8 "
    "nested: List(Struct(attr: UInt8,attr2=renamed: UInt8)) "
    "missing_from_source: Float32 "
)

# parse the schema and register json paths associated with final column names
s.to_struct()

# read as plain text using the lazy scan_csv() method before unpacking the data and
# renaming its fields to their final name (renamed during unpacking to their full
# respective json paths to avoid column naming collisions)
df = (
    pl.scan_csv(
        "**.ndjson",
        has_header=False,
        new_columns=["raw"],
        separator="|",  # or any other character *absent* from the raw data
    )
    .select(pl.col("raw").str.json_extract(s.struct))
    .unnest("raw")
    .json.unpack(s.struct)  # registered within the *frame namespaces
    .rename(s.json_paths)
)</code></pre><p>If your schema and JSON are stored as plain files the result above can be reached using any of the following helper functions:<pre class=highlight><code class=language-python>import polars as pl

from polars_unpack import unpack_text
from polars_unpack import unpack_ndjson

df = unpack_text("**.ndjson", "file.schema")
df = unpack_ndjson("**.ndjson", "file.schema")</code></pre><p>Note that these functions are using <code>scan_csv()</code> and <code>scan_ndjson()</code> respectively; any extra parameters passed to <code>unpack_text()</code> or <code>unpack_ndjson()</code> functions will be forwarded to these methods (with the exception of the <code>separator</code> argument, read the docstring of <code>unpack_text()</code> for more information).</div><span class=spacer></span><footer><a id=prev></a> <span class=spacer></span> <a id=next></a></footer></article></main>